pipeline {
    agent any

    environment {
        IMAGE_NAME='rating'
        VERSION="v${env.BUILD_NUMBER}"
        REPO='shtemeron/rating'
        CREDENTIALS_ID='docker-credentials'
    }

    stages {
        
        stage('Lint/Test') {
            steps {
                   sh "docker build --target lint-test --tag ${IMAGE_NAME}:${VERSION}-lint-test welcome/app/bookinfo/src/ratings"
                   sh "docker run --rm ${IMAGE_NAME}:${VERSION}-lint-test
            }
        }
        stage('Run') {
            steps {
                   sh "docker build --target run --tag ${IMAGE_NAME}:${VERSION}-run welcome/app/bookinfo/src/ratings"
            }
        }
        stage('Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/',"${CREDENTIALS_ID}"){
                        sh "docker tag ${IMAGE_NAME}:${VERSION}-run ${REPO}:${VERSION}"
                        sh "docker push ${REPO}:${VERSION}"
                   }
                }   
            }  
        }    
    }
}    
