pipeline {
    agent any

    environment {
        IMAGE_NAME='docker-ex1-jenkins'
        VERSION="v${env.BUILD_NUMBER}"
        REPO='shtemeron/docker-ex1-jenkins'
        CREDENTIALS_ID='docker-credentials'
    }

    stages {
        
        stage('Build') {
            steps {
                //Build the Docker image for the build stage
                   //sh 'pwd'
                   //sh 'cd repo/welcome/app/bookinfo/src/productpage'
                   sh "docker build --tag ${IMAGE_NAME}:${VERSION}-build welcome/app/bookinfo/src/productpage"
            }
        }
        //stage('Test') {
           // steps {
            //       sh "docker build --tag ${IMAGE_NAME}:${VERSION}-test welcome/app/bookinfo/src/productpage"
           //        sh "docker run --rm ${IMAGE_NAME}:${VERSION}-test"
         //   }
      //  }
        stage('Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/',"${CREDENTIALS_ID}"){
                        sh "docker tag ${IMAGE_NAME}:${VERSION}-build ${REPO}:${VERSION}"
                        sh "docker push ${REPO}/${IMAGE_NAME}:${VERSION}"
                   }
                }   
            }  
        }    
    }
}    

